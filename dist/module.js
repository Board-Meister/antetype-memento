var s={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"};var I="core",b="0.0.5",C=class{#e;#t=null;#a=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(r){this.#e=r}async loadModules(r){return(await this.#r()).loadModules(r)}register(r){let{registration:t}=r.detail;t[I]={load:async()=>(this.#t??=(await this.#n("core.js")).default,i=>this.#t({modules:i,herald:this.#e.herald})),version:b}}static subscriptions={[s.MODULES]:"register"};#n(r){return import(this.#e.marshal.getResourceUrl(this,r))}async#r(){return this.#a??=(await this.#n("helper.js")).default,new this.#a(this.#e.herald)}};var y="memento",h="0.0.4",f=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(t){this.#e=t}register(t){let{registration:i}=t.detail;i[y]={load:async()=>{if(!this.#t){let o=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(o)).default}return o=>this.#t({modules:o,herald:this.#e.herald})},version:h}}static subscriptions={[s.MODULES]:"register"}};function v({herald:r,modules:t}){let i=[],o=[],l=e=>{if(e.ctrlKey){if(e.key==="z"){u();return}if(e.key==="y"){d();return}}},g=e=>{let a=[];return e.forEach(n=>{a.push({instance:n,original:t.core.clone.getOriginal(n.layer)})}),a},c=e=>{i.push(g(e)),o=[],i.length>100&&i.shift()},u=async()=>{if(i.length===0)return;let e=i.splice(-1)[0];o.push(e),await t.core.view.recalculate();for(let a of e)await a.instance.undo(a.original,a.instance.data??void 0);t.core.view.redraw()},d=async()=>{if(o.length===0)return;let e=o.splice(-1)[0];i.push(e),await t.core.view.recalculate();for(let a of e)await a.instance.redo(a.original,a.instance.data??void 0);t.core.view.redraw()},m=(e=null)=>{e??=t.core.meta.getCanvas();let a=r.batch([{event:"antetype.memento.save",subscription:n=>{c(n.detail.state)},anchor:e},{event:s.CLOSE,subscription:()=>{let n=t.core.meta.getCanvas();n instanceof HTMLCanvasElement&&n.removeEventListener("keyup",l,!1),a()},anchor:e},{event:s.CANVAS_CHANGE,subscription:({detail:{current:n,previous:p}})=>{a(),p instanceof HTMLCanvasElement&&p.removeEventListener("keyup",l,!1),n instanceof HTMLCanvasElement&&(n.addEventListener("keyup",l,!1),m(n))},anchor:e}])};return m(),{addToStack:c,undo:u,redo:d}}export{v as default};
