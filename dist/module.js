var s={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"},C=Symbol("original"),E=Symbol("clone");var S=Symbol("layer");var I="core",w="0.0.5",M=class{#e;#t=null;#a=!1;#n=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(i){this.#e=i}async loadModules(i){return(await this.#i()).loadModules(i)}register(i){let{registration:t}=i.detail;t[I]={load:async()=>(!this.#t&&!this.#a&&(this.#a=new Promise(n=>{this.#r("core.js").then(o=>{this.#t=o.default,this.#a=!1,n()})})),this.#a&&await this.#a,n=>this.#t({modules:n,herald:this.#e.herald})),version:w}}static subscriptions={[s.MODULES]:"register"};#r(i){return import(this.#e.marshal.getResourceUrl(this,i))}async#i(){return this.#n??=(await this.#r("helper.js")).default,new this.#n(this.#e.herald)}};var y="memento",f="0.0.4",h=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(t){this.#e=t}register(t){let{registration:n}=t.detail;n[y]={load:async()=>{if(!this.#t){let o=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(o)).default}return o=>this.#t({modules:o,herald:this.#e.herald})},version:f}}static subscriptions={[s.MODULES]:"register"}};function v({herald:i,modules:t}){let n=[],o=[],l=e=>{if(e.ctrlKey){if(e.key==="z"){u();return}if(e.key==="y"){d();return}}},g=e=>{let a=[];return e.forEach(r=>{a.push({instance:r,original:t.core.clone.getOriginal(r.layer)})}),a},c=e=>{n.push(g(e)),o=[],n.length>100&&n.shift()},u=async()=>{if(n.length===0)return;let e=n.splice(-1)[0];o.push(e),await t.core.view.recalculate();for(let a of e)await a.instance.undo(a.original,a.instance.data??void 0);t.core.view.redraw()},d=async()=>{if(o.length===0)return;let e=o.splice(-1)[0];n.push(e),await t.core.view.recalculate();for(let a of e)await a.instance.redo(a.original,a.instance.data??void 0);t.core.view.redraw()},m=(e=null)=>{e??=t.core.meta.getCanvas();let a=i.batch([{event:"antetype.memento.save",subscription:r=>{c(r.detail.state)},anchor:e},{event:s.CLOSE,subscription:()=>{let r=t.core.meta.getCanvas();r instanceof HTMLCanvasElement&&r.removeEventListener("keyup",l,!1),a()},anchor:e},{event:s.CANVAS_CHANGE,subscription:({detail:{current:r,previous:p}})=>{a(),p instanceof HTMLCanvasElement&&p.removeEventListener("keyup",l,!1),r instanceof HTMLCanvasElement&&(r.addEventListener("keyup",l,!1),m(r))},anchor:e}])};return m(),{addToStack:c,undo:u,redo:d}}export{v as default};
