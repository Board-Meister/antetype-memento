var s={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var v="core",b="0.0.5",S=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(a){this.#e=a}async loadModules(a,t){return(await this.#n()).loadModules(a,t)}register(a){let{registration:t}=a.detail;t[v]={load:async()=>(this.#t??=(await this.#a("core.js")).default,(o,r)=>this.#t({canvas:r,modules:o,herald:this.#e.herald})),version:b}}static subscriptions={[s.MODULES]:"register"};#a(a){return import(this.#e.marshal.getResourceUrl(this,a))}async#n(){return this.#r??=(await this.#a("helper.js")).default,new this.#r(this.#e.herald)}};var h="memento",y="0.0.4",p=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(t){this.#e=t}register(t){let{registration:o}=t.detail;o[h]={load:async()=>{if(!this.#t){let r=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(r)).default}return(r,i)=>this.#t({canvas:i,modules:r,herald:this.#e.herald})},version:y}}static subscriptions={[s.MODULES]:"register"}};function f({herald:a,modules:t,canvas:o}){let r=[],i=[],l=e=>{if(e.ctrlKey){if(e.key==="z"){d();return}if(e.key==="y"){u();return}}},I=e=>{let n=[];return e.forEach(m=>{n.push({instance:m,original:t.core.clone.getOriginal(m.layer)})}),n},c=e=>{r.push(I(e)),i=[],r.length>100&&r.shift()},d=async()=>{if(r.length===0)return;let e=r.splice(-1)[0];i.push(e),await t.core.view.recalculate();for(let n of e)await n.instance.undo(n.original,n.instance.data??void 0);t.core.view.redraw()},u=async()=>{if(i.length===0)return;let e=i.splice(-1)[0];r.push(e),await t.core.view.recalculate();for(let n of e)await n.instance.redo(n.original,n.instance.data??void 0);t.core.view.redraw()};o?.addEventListener("keyup",l,!1);let g=a.batch([{event:"antetype.memento.save",subscription:e=>{c(e.detail.state)}},{event:s.CLOSE,subscription:()=>{o?.removeEventListener("keyup",l,!1),g()}}]);return{addToStack:c,undo:d,redo:u}}export{f as default};
