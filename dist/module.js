var s={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},S=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(a){this.#e=a}async#n(a,t){let r=this.#e.minstrel.getResourceUrl(this,"core.js");return this.#t=(await import(r)).default,this.#t({canvas:t,modules:a,herald:this.#e.herald})}async register(a){let{modules:t,canvas:r}=a.detail;t.core=await this.#n(t,r)}static subscriptions={[s.MODULES]:"register"}};var p=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(t){this.#e=t}async register(t){let{modules:r,canvas:o}=t.detail;if(!this.#t){let i=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(i)).default}r.memento=this.#t({canvas:o,modules:r,herald:this.#e.herald})}static subscriptions={[s.MODULES]:"register"}};function v({herald:a,modules:t,canvas:r}){let o=[],i=[],d=e=>{if(e.ctrlKey){if(e.key==="z"){l();return}if(e.key==="y"){m();return}}},I=e=>{let n=[];return e.forEach(u=>{n.push({instance:u,original:t.core.clone.getOriginal(u.layer)})}),n},c=e=>{o.push(I(e)),i=[],o.length>100&&o.shift()},l=async()=>{if(o.length===0)return;let e=o.splice(-1)[0];i.push(e),await t.core.view.recalculate();for(let n of e)await n.instance.undo(n.original,n.instance.data??void 0);t.core.view.redraw()},m=async()=>{if(i.length===0)return;let e=i.splice(-1)[0];o.push(e),await t.core.view.recalculate();for(let n of e)await n.instance.redo(n.original,n.instance.data??void 0);t.core.view.redraw()};r?.addEventListener("keyup",d,!1);let f=a.batch([{event:"antetype.memento.save",subscription:e=>{c(e.detail.state)}},{event:s.CLOSE,subscription:()=>{r?.removeEventListener("keyup",d,!1),f()}}]);return{addToStack:c,undo:l,redo:m}}export{v as default};
